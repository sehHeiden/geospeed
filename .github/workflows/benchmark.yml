name: Benchmarks
on:
  pull_request: { paths: ['pyproject.toml', 'uv.lock'] }
  push: { branches: [master], paths: ['pyproject.toml', 'uv.lock', 'geospeed/**', 'scripts/**', '.github/workflows/**'] }
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest-4-cores-arm
    permissions:
      contents: write  # Allow pushing commits back to repo
    timeout-minutes: ${{ github.event_name == 'pull_request' && 10 || 60 }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Cache system packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/benchmark.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-
      
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
      
      - name: Install GDAL and Java
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y gdal-bin libgdal-dev openjdk-11-jdk
          echo "Installed GDAL version: $(gdal-config --version)"
      
      - name: Set JAVA_HOME and check system specs
        run: |
          # Set JAVA_HOME based on architecture
          if [[ $(uname -m) == "aarch64" ]]; then
            JAVA_HOME_PATH="/usr/lib/jvm/java-11-openjdk-arm64"
          else
            JAVA_HOME_PATH="/usr/lib/jvm/java-11-openjdk-amd64"
          fi
          echo "JAVA_HOME=$JAVA_HOME_PATH" >> $GITHUB_ENV
          export JAVA_HOME="$JAVA_HOME_PATH"
          echo "JAVA_HOME set to: $JAVA_HOME"
          java -version
          echo "=== System Specs ==="
          echo "CPU cores: $(nproc)"
          echo "CPU info: $(lscpu | grep 'Model name' || echo 'CPU info not available')"
          echo "Memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
          echo "Disk: $(df -h / | tail -1 | awk '{print $2}')"
          echo "==================="
      - run: uv sync && mkdir -p ALKIS_TEST/test_county
      
      - name: Install geofileops for benchmarking
        run: |
          # Check system GDAL version
          GDAL_VERSION=$(gdal-config --version)
          echo "System GDAL version: $GDAL_VERSION"
          
          # Install geofileops with GDAL version matching system libgdal
          if [[ "$GDAL_VERSION" == "3.8.4" ]]; then
            echo "Installing geofileops with GDAL 3.8.4 to match system libgdal"
            uv add 'geofileops>=0.8.0' 'GDAL==3.8.4' || {
              echo "Failed to install geofileops with GDAL 3.8.4, trying alternative"
              uv add 'geofileops>=0.8.0' 'GDAL>=3.8.0,<3.8.5' || {
                echo "Could not install geofileops with compatible GDAL version"
                echo "Skipping geofileops benchmark in this run"
              }
            }
          else
            echo "Installing geofileops with system GDAL version $GDAL_VERSION"
            uv add 'geofileops>=0.8.0' || {
              echo "Could not install geofileops"
              echo "Skipping geofileops benchmark in this run"
            }
          fi
      - run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            uv run python -c "import geopandas, pyogrio, duckdb; print('âœ… OK')"
          else
            timeout 3600 uv run python scripts/benchmarks.py
            uv run python scripts/update_readme.py
            git diff --quiet readme.md || {
              git config user.email "action@github.com"
              git config user.name "GitHub Action"
              git add readme.md
              git commit -m "Update benchmarks"
              git push
            }
          fi
